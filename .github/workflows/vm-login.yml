name: "Update VM Docker"

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      is_dev:
        required: true
        type: boolean
      is_image:
        required: true
        type: boolean
      port:
        required: false
        type: string

jobs:
  vm_actions:
    name: Update VM Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Login to VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.is_dev && secrets.ssh_host_dev || secrets.ssh_host }}
          username: ${{ inputs.is_dev && secrets.ssh_user_dev || secrets.ssh_user }}
          key: ${{ inputs.is_dev && secrets.ssh_key_dev || secrets.ssh_key }}
          port: 22
          script: |
            cd Infraestructure
            
            # Log in to Docker
            sudo docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
            
            # Pull the latest image
            sudo docker pull ghcr.io/printscript8/${{ inputs.service_name }}:latest
            
            # Stop and remove any existing container
            sudo docker stop ${{ inputs.service_name }} || true
            sudo docker rm ${{ inputs.service_name }} || true
            
            # Determine if we are in dev or prod environment based on 'is_dev' and 'is_image' inputs
              if [ ${{ inputs.is_dev }} = "true" ]; then
              if [ ${{ inputs.is_image }} = "true" ]; then
              echo "Running docker-compose.dev.yaml with image"
              sudo docker-compose -f docker-compose.dev.yaml up -d
              else
              echo "Running docker-compose.dev.yaml without image"
              sudo docker-compose -f docker-compose.dev.yaml up -d --no-build
              fi
              elif [ ${{ inputs.is_dev }} = "false" ]; then
              if [ ${{ inputs.is_image }} = "true" ]; then
              echo "Running docker-compose.prod.yaml with image"
              sudo docker-compose -f docker-compose.prod.yaml up -d
              else
              echo "Running docker-compose.prod.yaml without image"
              sudo docker-compose -f docker-compose.prod.yaml up -d --no-build
              fi
              else
              # Default case: Run the container directly
              echo "Running the container without docker-compose"
              sudo docker run -d --name ${{ inputs.service_name }} -p ${{inputs.port}}:8080 ghcr.io/printscript8/${{ inputs.service_name }}:latest
              fi